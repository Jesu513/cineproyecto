<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin ‚Äì Reservas</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-slate-900 text-white">

    <div class="flex">

        <!-- Sidebar -->
        <div id="adminSidebar" class="w-64"></div>

        <!-- Main -->
        <main class="flex-1 p-10">

            <h1 class="text-4xl font-bold mb-8">üéüÔ∏è Gesti√≥n de Reservas</h1>

            <!-- FILTROS SUPERIORES -->
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">

                <select id="filterStatus" class="p-2 bg-slate-800 border border-slate-700 rounded">
                    <option value="">Todos los estados</option>
                    <option value="pending">Pendiente</option>
                    <option value="confirmed">Confirmada</option>
                    <option value="cancelled">Cancelada</option>
                    <option value="completed">Completada</option>
                    <option value="expired">Expirada</option>
                </select>

                <select id="filterMovie" class="p-2 bg-slate-800 border border-slate-700 rounded">
                    <option value="">Todas las pel√≠culas</option>
                </select>

                <select id="filterUser" class="p-2 bg-slate-800 border border-slate-700 rounded">
                    <option value="">Todos los usuarios</option>
                </select>

                <input id="filterDate" type="date"
                       class="p-2 bg-slate-800 border border-slate-700 rounded" />
            </div>

            <!-- TABLA -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-700 text-left">
                            <th class="p-3">C√≥digo</th>
                            <th class="p-3">Usuario</th>
                            <th class="p-3">Pel√≠cula</th>
                            <th class="p-3">Fecha</th>
                            <th class="p-3">Asientos</th>
                            <th class="p-3">Total</th>
                            <th class="p-3">Estado</th>
                            <th class="p-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable"></tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- Components -->
    <script type="text/babel" src="../../components/AdminSidebar.jsx"></script>
    <script type="text/babel" src="../../components/Modal.jsx"></script>

    <!-- API -->
    <script src="../../utils/api.js"></script>

    <!-- Page Logic -->
    <script type="text/babel">

        // Sidebar
        ReactDOM.createRoot(document.getElementById("adminSidebar"))
            .render(<AdminSidebar active="bookings" />);

        let bookings = [];
        let movies = [];
        let users = [];

        // ======================================================
        // 1. Cargar datos iniciales
        // ======================================================
        async function loadInitialData() {
            const [moviesRes, usersRes, bookingsRes] = await Promise.all([
                api.get("/admin/movies"),
                api.get("/admin/users"),
                api.get("/admin/bookings")
            ]);

            movies = moviesRes.data || [];
            users = usersRes.data || [];
            bookings = bookingsRes.data || [];

            fillSelects();
            redrawTable();
        }

        // ======================================================
        // 2. Llenar combos de filtro
        // ======================================================
        function fillSelects() {
            const movieSel = document.getElementById("filterMovie");
            const userSel = document.getElementById("filterUser");

            movies.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.id;
                opt.textContent = m.title;
                movieSel.appendChild(opt);
            });

            users.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.id;
                opt.textContent = u.name;
                userSel.appendChild(opt);
            });
        }

        // ======================================================
        // 3. Dibujar tabla con filtros
        // ======================================================
        function redrawTable() {
            const tbody = document.getElementById("bookingsTable");
            tbody.innerHTML = "";

            const fStatus = document.getElementById("filterStatus").value;
            const fMovie = document.getElementById("filterMovie").value;
            const fUser = document.getElementById("filterUser").value;
            const fDate = document.getElementById("filterDate").value;

            bookings
                .filter(b => fStatus === "" || b.status === fStatus)
                .filter(b => fMovie === "" || String(b.movie_id) === fMovie)
                .filter(b => fUser === "" || String(b.user_id) === fUser)
                .filter(b => fDate === "" || b.show_date === fDate)
                .forEach(b => {

                    const statusColor = {
                        pending: "bg-yellow-600",
                        confirmed: "bg-emerald-600",
                        cancelled: "bg-red-600",
                        completed: "bg-blue-600",
                        expired: "bg-gray-600"
                    }[b.status];

                    const tr = document.createElement("tr");
                    tr.className = "border-b border-slate-700";

                    tr.innerHTML = `
                        <td class="p-3">${b.booking_code}</td>
                        <td class="p-3">${b.customer_name}</td>
                        <td class="p-3">${b.movie_title}</td>
                        <td class="p-3">${b.show_date} ${b.show_time}</td>
                        <td class="p-3">${b.total_seats}</td>
                        <td class="p-3">S/ ${b.final_amount}</td>

                        <td class="p-3">
                            <span class="px-3 py-1 rounded text-sm ${statusColor}">
                                ${b.status}
                            </span>
                        </td>

                        <td class="p-3">
                            <button class="text-sky-400 hover:text-sky-300 mr-3"
                                    onclick="viewDetails(${b.id})">
                                Ver
                            </button>

                            ${b.status === 'confirmed'
                                ? `<button class="text-red-400 hover:text-red-300"
                                           onclick="cancelBooking(${b.id})">Cancelar</button>`
                                : ""
                            }
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
        }

        // ======================================================
        // 4. Ver detalles en modal
        // ======================================================
        async function viewDetails(id) {
            const res = await api.get(`/admin/bookings/${id}`);
            const bk = res.data;

            const seats = bk.seats.map(s => `${s.row_label}${s.seat_number}`).join(", ");

            const modalContent = (
                <div className="space-y-3">
                    <p><b>C√≥digo:</b> {bk.booking_code}</p>
                    <p><b>Usuario:</b> {bk.customer_name}</p>
                    <p><b>Pel√≠cula:</b> {bk.movie_title}</p>
                    <p><b>Fecha:</b> {bk.show_date} {bk.show_time}</p>
                    <p><b>Asientos:</b> {seats}</p>
                    <p><b>Monto final:</b> S/ {bk.final_amount}</p>
                    <p><b>Estado:</b> {bk.status}</p>

                    {bk.payment && (
                        <div className="mt-4 p-3 bg-slate-700 rounded-lg">
                            <p class="font-semibold mb-2">üí≥ Informaci√≥n de pago</p>
                            <p><b>M√©todo:</b> {bk.payment.payment_method}</p>
                            <p><b>Transacci√≥n:</b> {bk.payment.transaction_id}</p>
                            <p><b>Estado pago:</b> {bk.payment.status}</p>
                        </div>
                    )}
                </div>
            );

            Modal.show({
                title: "Detalles de la Reserva",
                content: modalContent,
                showCancel: false,
                confirmText: "Cerrar"
            });
        }

        window.viewDetails = viewDetails;

        // ======================================================
        // 5. Cancelar una reserva
        // ======================================================
        async function cancelBooking(id) {
            if (!confirm("¬øCancelar esta reserva?")) return;

            await api.patch(`/admin/bookings/${id}/status`, {
                status: "cancelled"
            });

            await loadInitialData();
        }

        window.cancelBooking = cancelBooking;

        // ======================================================
        // 6. Eventos
        // ======================================================
        document.getElementById("filterStatus").onchange = redrawTable;
        document.getElementById("filterMovie").onchange = redrawTable;
        document.getElementById("filterUser").onchange = redrawTable;
        document.getElementById("filterDate").onchange = redrawTable;

        // ======================================================
        // 7. Inicializar p√°gina
        // ======================================================
        loadInitialData();

    </script>

</body>

</html>
