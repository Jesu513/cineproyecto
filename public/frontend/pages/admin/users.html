<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€“ Usuarios</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

</head>

<body class="bg-slate-900 text-white">

    <div class="flex">

        <!-- SIDEBAR -->
        <div id="adminSidebar" class="w-64"></div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-10">

            <h1 class="text-4xl font-bold mb-8">ðŸ‘¥ GestiÃ³n de Usuarios</h1>

            <!-- FILTROS -->
            <div class="flex flex-wrap gap-4 mb-6">

                <input id="searchInput" type="text" placeholder="Buscar usuario..."
                    class="px-4 py-2 w-72 bg-slate-800 border border-slate-700 rounded">

                <select id="filterRole" class="px-4 py-2 bg-slate-800 border border-slate-700 rounded">
                    <option value="">Todos los roles</option>
                    <option value="customer">Clientes</option>
                    <option value="staff">Staff</option>
                    <option value="admin">Administradores</option>
                </select>

                <select id="filterStatus" class="px-4 py-2 bg-slate-800 border border-slate-700 rounded">
                    <option value="">Todos</option>
                    <option value="1">Activos</option>
                    <option value="0">Bloqueados</option>
                </select>
            </div>

            <!-- TABLA -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-700 text-left">
                            <th class="p-3">Nombre</th>
                            <th class="p-3">Email</th>
                            <th class="p-3">Rol</th>
                            <th class="p-3">Estado</th>
                            <th class="p-3">Registrado</th>
                            <th class="p-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>

        </main>
    </div>


    <!-- COMPONENTS -->
    <script type="text/babel" src="../../components/AdminSidebar.jsx"></script>
    <script type="text/babel" src="../../components/Modal.jsx"></script>

    <!-- API helper -->
    <script src="../../utils/api.js"></script>

    <!-- LOGIC SCRIPT -->
    <script type="text/babel">

        // ====== SIDEBAR ======
        ReactDOM.createRoot(document.getElementById("adminSidebar"))
            .render(<AdminSidebar active="users" />);

        let usersList = [];
        let editingUser = null;

        // ============================
        // 1. Cargar usuarios
        // ============================
        async function loadUsers() {
            const res = await api.get("/admin/users");
            usersList = res.data || [];
            redrawTable();
        }

        // ============================
        // 2. Dibujar tabla
        // ============================
        function redrawTable() {
            const tbody = document.getElementById("usersTable");
            tbody.innerHTML = "";

            const search = document.getElementById("searchInput").value.toLowerCase();
            const roleFilter = document.getElementById("filterRole").value;
            const statusFilter = document.getElementById("filterStatus").value;

            usersList
                .filter(u => u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search))
                .filter(u => roleFilter === "" || u.role === roleFilter)
                .filter(u => statusFilter === "" || String(u.is_active) === statusFilter)
                .forEach(u => {

                    const statusBadge = u.is_active
                        ? `<span class="px-3 py-1 rounded bg-emerald-600 text-sm">Activo</span>`
                        : `<span class="px-3 py-1 rounded bg-red-600 text-sm">Bloqueado</span>`;

                    const tr = document.createElement("tr");
                    tr.className = "border-b border-slate-700";

                    tr.innerHTML = `
                        <td class="p-3 font-semibold">${u.name}</td>
                        <td class="p-3">${u.email}</td>
                        <td class="p-3 capitalize">${u.role}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3">${u.created_at}</td>

                        <td class="p-3">
                            <button class="text-sky-400 hover:text-sky-300 mr-3"
                                    onclick="editUser(${u.id})">
                                Editar
                            </button>

                            <button class="text-red-400 hover:text-red-300"
                                    onclick="toggleUser(${u.id}, ${u.is_active})">
                                ${u.is_active ? "Bloquear" : "Desbloquear"}
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
        }

        // Expose functions
        window.editUser = editUser;
        window.toggleUser = toggleUser;

        // ============================
        // 3. Bloquear / desbloquear usuario
        // ============================
        async function toggleUser(id, current) {
            await api.patch(`/admin/users/${id}/status`, {
                is_active: !current
            });
            loadUsers();
        }

        // ============================
        // 4. Editar usuario
        // ============================
        function editUser(id) {
            editingUser = usersList.find(u => u.id === id);
            openUserModal(editingUser);
        }

        // ============================
        // 5. Modal para editar usuario
        // ============================
        function openUserModal(user) {

            const modalContent = (
                <div className="space-y-4">

                    <input id="us_name" defaultValue={user.name}
                        placeholder="Nombre"
                        className="w-full p-2 bg-slate-800 border border-slate-700 rounded" />

                    <input id="us_email" defaultValue={user.email}
                        placeholder="Email" disabled
                        className="w-full p-2 bg-slate-800 border border-slate-700 rounded opacity-50 cursor-not-allowed" />

                    <input id="us_phone" defaultValue={user.phone || ""}
                        placeholder="TelÃ©fono"
                        className="w-full p-2 bg-slate-800 border border-slate-700 rounded" />

                    <select id="us_role"
                        className="w-full p-2 bg-slate-800 border border-slate-700 rounded">
                        <option value="customer" selected={user.role === "customer"}>Cliente</option>
                        <option value="staff" selected={user.role === "staff"}>Staff</option>
                        <option value="admin" selected={user.role === "admin"}>Administrador</option>
                    </select>

                    <div className="flex items-center gap-2">
                        <input id="us_active" type="checkbox" defaultChecked={user.is_active} />
                        <label>Usuario activo</label>
                    </div>

                </div>
            );

            const onConfirm = async () => {
                const payload = {
                    name: document.getElementById("us_name").value,
                    phone: document.getElementById("us_phone").value,
                    role: document.getElementById("us_role").value,
                    is_active: document.getElementById("us_active").checked
                };

                await api.put(`/admin/users/${user.id}`, payload);
                loadUsers();
            };

            Modal.show({
                title: "Editar Usuario",
                content: modalContent,
                confirmText: "Guardar Cambios",
                onConfirm
            });
        }

        // ============================
        // 6. Eventos de filtro
        // ============================
        document.getElementById("searchInput").onkeyup = redrawTable;
        document.getElementById("filterRole").onchange = redrawTable;
        document.getElementById("filterStatus").onchange = redrawTable;

        // ============================
        // 7. Inicializar
        // ============================
        loadUsers();

    </script>

</body>
</html>
